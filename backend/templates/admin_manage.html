<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Administration</title>
  <link rel="stylesheet" href="/static/admin.css">
</head>
<body>
<h2>Administration</h2>
<p>Welcome, administrator. <a href="/admin/logout">Logout</a></p>

<section>
  <h3>Photos</h3>
  <form id="uploadPhotoForm">
    <input type="text" name="title" id="photoTitle" placeholder="Title">
    <input type="text" name="description" id="photoDesc" placeholder="Description">
    <div id="photoDropZone" class="dropzone">
      <input type="file" name="file" id="photoFile" accept="image/*" required>
      <div id="photoPreview" class="preview">Aucun fichier sélectionné</div>
      <div class="dz-hint">Glisser déposer une image ici ou cliquez pour sélectionner</div>
    </div>
    <progress id="photoProgress" value="0" max="100" style="display:none;"></progress>
    <div id="photoError" class="inline-error" style="display:none;color:#b00;margin-top:6px;"></div>
    <button type="submit">Upload Photo</button>
  </form>
  <div id="photosList">Loading photos...</div>
</section>

<section>
  <h3>Articles</h3>
  <form id="articleForm">
    <input type="hidden" id="articleId" name="id">
    <div>
      <label for="articleTitle">Title</label><br>
      <input type="text" id="articleTitle" name="title" placeholder="Title" style="width:100%;">
    </div>
    <div>
      <label for="articleAuthor">Author</label><br>
      <input type="text" id="articleAuthor" name="author" placeholder="Author">
    </div>
      <div>
        <label for="articleImageSelect">Image</label><br>
        <select id="articleImageSelect" name="image" style="width:100%;">
          <option value="">(no image)</option>
        </select>
        <div style="margin-top:6px;">
          <input type="file" id="articleImageFile" accept="image/*">
          <button type="button" id="articleImageUploadBtn">Upload & attach</button>
        </div>
      </div>
      <div>
        <label for="articleVideoSelect">Video</label><br>
        <select id="articleVideoSelect" name="video" style="width:100%;">
          <option value="">(no video)</option>
        </select>
        <div style="margin-top:6px;">
          <input type="file" id="articleVideoFile" accept="video/*">
          <button type="button" id="articleVideoUploadBtn">Upload & attach video</button>
        </div>
      </div>
    <div>
      <label for="articleContent">Content (Markdown)</label><br>
      <div style="margin-bottom:6px;">
        <button type="button" class="md-btn" data-ins="# ">H1</button>
        <button type="button" class="md-btn" data-ins="## ">H2</button>
        <button type="button" class="md-btn" data-ins="### ">H3</button>
        <button type="button" class="md-btn" data-ins="**bold**">Bold</button>
        <button type="button" class="md-btn" data-ins="*italic*">Italic</button>
        <button type="button" class="md-btn" data-ins="- ">List</button>
        <button type="button" id="mdLinkBtn">Link</button>
        <button type="button" id="togglePreviewBtn">Preview</button>
      </div>
      <textarea id="articleContent" name="content" rows="10" style="width:100%;" placeholder="Article content (Markdown)"></textarea>
      <div id="articlePreview" style="border:1px solid #ddd;padding:8px;margin-top:8px;display:none;background:#fff;"></div>
    </div>
    <div style="margin-top:8px;">
      <button type="submit">Save Article</button>
      <button type="button" id="articleClear">Clear</button>
    </div>
  </form>
  <div id="articlesList">Loading articles...</div>
</section>

<section>
  <h3>Videos</h3>
  <form id="uploadVideoForm">
    <input type="text" name="title" id="videoTitle" placeholder="Title">
    <input type="text" name="description" id="videoDesc" placeholder="Description">
    <input type="file" name="file" id="videoFile" accept="video/*" required>
    <progress id="videoProgress" value="0" max="100" style="display:none;"></progress>
    <button type="submit">Upload Video</button>
  </form>
  <div id="videosList">Loading videos...</div>
</section>

<section>
  <h3>Paramètres du site</h3>
  <form id="siteMetaForm">
    <div>
      <label for="siteTitle">Titre (en-tête)</label><br>
      <input type="text" id="siteTitle" name="site_title" style="width:100%;">
    </div>
    <div>
      <label for="siteSubtitle">Sous-titre (grand titre)</label><br>
      <input type="text" id="siteSubtitle" name="site_subtitle" style="width:100%;">
    </div>
    <div>
      <label for="footerText">Footer (HTML autorisé)</label><br>
      <textarea id="footerText" name="footer_text" rows="3" style="width:100%;"></textarea>
    </div>
    <div>
      <label for="pillarsHtml">Piliers (HTML)</label><br>
      <textarea id="pillarsHtml" name="pillars_html" rows="6" style="width:100%;"></textarea>
    </div>
    <div>
      <label for="contactHtml">Contact (HTML)</label><br>
      <textarea id="contactHtml" name="contact_html" rows="4" style="width:100%;"></textarea>
    </div>
    <div style="margin-top:8px;">
      <button type="submit">Enregistrer les paramètres</button>
    </div>
  </form>
  <div id="siteMetaMsg" style="margin-top:8px;color:green;display:none;"></div>
</section>

<script>
const CSRF = '{{ csrf }}';
const MAX_IMAGE = {{ max_image | default(0) }};
const MAX_VIDEO = {{ max_video | default(0) }};

function validateImageSize(file){
  if(!file) return true;
  if(MAX_IMAGE && file.size > MAX_IMAGE){
    alert('Le fichier dépasse la taille maximale autorisée (' + Math.round(MAX_IMAGE/1024/1024) + ' MB)');
    return false;
  }
  return true;
}

function validateVideoSize(file){
  if(!file) return true;
  if(MAX_VIDEO && file.size > MAX_VIDEO){
    alert('La vidéo dépasse la taille maximale autorisée (' + Math.round(MAX_VIDEO/1024/1024) + ' MB)');
    return false;
  }
  return true;
}

async function fetchPhotos(){
  const r = await fetch('/api/photos');
  const j = await r.json();
  const container = document.getElementById('photosList');
  if(!j.photos || j.photos.length === 0){ container.innerHTML = '<p>No photos</p>'; return; }
  const ul = document.createElement('ul');
  // also populate article image select
  const imageSelect = document.getElementById('articleImageSelect');
  if(imageSelect) { imageSelect.innerHTML = '<option value="">(no image)</option>'; }
  j.photos.forEach(p => {
    const li = document.createElement('li');
    li.innerHTML = `<strong>${p.title || ''}</strong> - ${p.description || ''} - <a href="/static/uploads/photos/${p.filename}" target="_blank">view</a> `;
    const del = document.createElement('button');
    del.textContent = 'Delete';
    del.addEventListener('click', async ()=>{
      if(!confirm('Delete this photo?')) return;
      const res = await fetch(`/api/photos/${p.id}`, {method:'DELETE', headers:{'X-CSRF-Token': CSRF}});
      if(res.ok) { fetchPhotos(); }
      else alert('Delete failed');
    });
    li.appendChild(del);
    ul.appendChild(li);
      if(imageSelect){
        const opt = document.createElement('option');
        opt.value = '/static/uploads/photos/' + p.filename;
        opt.textContent = (p.title || p.filename);
        imageSelect.appendChild(opt);
      }
  });
  container.innerHTML = '';
  container.appendChild(ul);
}

  // populate video select when videos fetched
  async function populateVideoSelect(videos){
    const sel = document.getElementById('articleVideoSelect');
    if(!sel) return;
    sel.innerHTML = '<option value="">(no video)</option>';
    videos.forEach(v => {
      const opt = document.createElement('option');
      opt.value = '/static/uploads/videos/' + v.filename;
      opt.textContent = (v.title || v.filename);
      sel.appendChild(opt);
    });
  }

// Articles admin section
async function fetchArticles(){
  const r = await fetch('/api/articles');
  const j = await r.json();
  const container = document.getElementById('articlesList');
  if(!j.articles || j.articles.length === 0){ container.innerHTML = '<p>No articles</p>'; return; }
  const ul = document.createElement('ul');
  j.articles.forEach(a => {
    const li = document.createElement('li');
    li.innerHTML = `<strong>${a.title}</strong> - ${a.author || ''} - <small>${a.created_at || ''}</small><div class="article-content">${a.content ? a.content.substring(0,200) : ''}</div>`;
    const edit = document.createElement('button');
    edit.textContent = 'Edit';
    edit.addEventListener('click', ()=> openEditArticle(a));
    const del = document.createElement('button');
    del.textContent = 'Delete';
    del.addEventListener('click', async ()=>{
      if(!confirm('Delete this article?')) return;
      const res = await fetch(`/api/articles/${a.id}`, {method:'DELETE', headers:{'X-CSRF-Token': CSRF}});
      if(res.ok) fetchArticles(); else alert('Delete failed');
    });
    li.appendChild(edit);
    li.appendChild(del);
    ul.appendChild(li);
  });
  container.innerHTML = '';
  container.appendChild(ul);
}

function openEditArticle(article){
  document.getElementById('articleId').value = article.id || '';
  document.getElementById('articleTitle').value = article.title || '';
  document.getElementById('articleAuthor').value = article.author || '';
  document.getElementById('articleContent').value = article.content || '';
  const sel = document.getElementById('articleImageSelect');
  if(sel){ sel.value = article.image || ''; }
  const vsel = document.getElementById('articleVideoSelect');
  if(vsel){ vsel.value = article.video || ''; }
  document.getElementById('articleForm').scrollIntoView({behavior:'smooth'});
}

document.getElementById('articleForm').addEventListener('submit', async function(e){
  e.preventDefault();
  const id = document.getElementById('articleId').value;
  const payload = {
    title: document.getElementById('articleTitle').value,
    author: document.getElementById('articleAuthor').value,
    content: document.getElementById('articleContent').value,
    image: (document.getElementById('articleImageSelect') ? document.getElementById('articleImageSelect').value : ''),
    video: (document.getElementById('articleVideoSelect') ? document.getElementById('articleVideoSelect').value : '')
  };
  const opts = {headers: {'Content-Type':'application/json','X-CSRF-Token': CSRF}};
  let res;
  if(id){
    res = await fetch(`/api/articles/${id}`, {method:'PUT', body: JSON.stringify(payload), ...opts});
  } else {
    res = await fetch('/api/articles', {method:'POST', body: JSON.stringify(payload), ...opts});
  }
  if(res.ok){
    alert('Saved');
    document.getElementById('articleId').value = '';
    document.getElementById('articleTitle').value = '';
    document.getElementById('articleAuthor').value = '';
    document.getElementById('articleContent').value = '';
    fetchArticles();
  } else {
    const j = await res.json().catch(()=>({error:'unknown'}));
    alert('Save failed: ' + (j.error || res.status));
  }
});

async function fetchVideos(){
  const r = await fetch('/api/videos');
  const j = await r.json();
  const container = document.getElementById('videosList');
  if(!j.videos || j.videos.length === 0){ container.innerHTML = '<p>No videos</p>'; return; }
  const ul = document.createElement('ul');
  j.videos.forEach(p => {
    const li = document.createElement('li');
    li.innerHTML = `<strong>${p.title || ''}</strong> - ${p.description || ''} - <a href="/static/uploads/videos/${p.filename}" target="_blank">view</a> `;
    const del = document.createElement('button');
    del.textContent = 'Delete';
    del.addEventListener('click', async ()=>{
      if(!confirm('Delete this video?')) return;
      const res = await fetch(`/api/videos/${p.id}`, {method:'DELETE', headers:{'X-CSRF-Token': CSRF}});
      if(res.ok) { fetchVideos(); }
      else alert('Delete failed');
    });
    li.appendChild(del);
    ul.appendChild(li);
    // also populate article video select
    const vsel = document.getElementById('articleVideoSelect');
    if(vsel){
      const opt = document.createElement('option');
      opt.value = '/static/uploads/videos/' + p.filename;
      opt.textContent = (p.title || p.filename);
      vsel.appendChild(opt);
    }
  });
  container.innerHTML = '';
  container.appendChild(ul);
}

function uploadWithProgress(url, form, progressEl){
  return new Promise((resolve, reject) => {
    const xhr = new XMLHttpRequest();
    xhr.open('POST', url);
    xhr.setRequestHeader('X-CSRF-Token', CSRF);
    xhr.upload.addEventListener('progress', (ev) => {
      if(ev.lengthComputable){
        progressEl.style.display = '';
        progressEl.value = Math.round((ev.loaded/ev.total)*100);
      }
    });
    xhr.onload = () => {
      progressEl.style.display = 'none';
      if(xhr.status >= 200 && xhr.status < 300){
        resolve(JSON.parse(xhr.responseText || '{}'));
      } else reject(xhr.status);
    };
    xhr.onerror = () => { progressEl.style.display = 'none'; reject('network'); };
    xhr.send(form);
  });
}

document.getElementById('uploadPhotoForm').addEventListener('submit', async function(e){
  e.preventDefault();
  const fd = new FormData();
  fd.append('title', document.getElementById('photoTitle').value);
  fd.append('description', document.getElementById('photoDesc').value);
  const photoFile = document.getElementById('photoFile').files[0];
  if(!validateImageSize(photoFile)) return;
  fd.append('file', photoFile);
  const prog = document.getElementById('photoProgress');
  const errBox = document.getElementById('photoError');
  errBox.style.display = 'none'; errBox.textContent = '';
  try{
    await uploadWithProgress('/api/photos', fd, prog);
    fetchPhotos();
    alert('Photo uploaded');
  }catch(e){ errBox.style.display=''; errBox.textContent = 'Upload failed. Vérifiez la taille/fichier et réessayez.'; }
});

// Drag & drop and preview logic
const dropZone = document.getElementById('photoDropZone');
const fileInput = document.getElementById('photoFile');
const preview = document.getElementById('photoPreview');

dropZone.addEventListener('click', ()=> fileInput.click());
fileInput.addEventListener('change', () => showPreview(fileInput.files[0]));

['dragenter','dragover'].forEach(ev=> dropZone.addEventListener(ev, (e)=>{ e.preventDefault(); dropZone.classList.add('dragover'); }));
['dragleave','drop'].forEach(ev=> dropZone.addEventListener(ev, (e)=>{ e.preventDefault(); dropZone.classList.remove('dragover'); }));

dropZone.addEventListener('drop', (e)=>{
  e.preventDefault();
  const f = e.dataTransfer.files[0];
  if(f){
    fileInput.files = e.dataTransfer.files; // set files
    if(validateImageSize(f)) showPreview(f);
  }
});

function showPreview(file){
  if(!file) {
    preview.textContent = 'Aucun fichier sélectionné';
    preview.style.backgroundImage = '';
    return;
  }
  if(!file.type.startsWith('image/')){
    preview.textContent = 'Fichier non image';
    preview.style.backgroundImage = '';
    return;
  }
  const reader = new FileReader();
  reader.onload = (ev)=>{
    preview.style.backgroundImage = `url(${ev.target.result})`;
    preview.textContent = '';
  };
  reader.readAsDataURL(file);
}

document.getElementById('uploadVideoForm').addEventListener('submit', async function(e){
  e.preventDefault();
  const fd = new FormData();
  fd.append('title', document.getElementById('videoTitle').value);
  fd.append('description', document.getElementById('videoDesc').value);
  const videoFile = document.getElementById('videoFile').files[0];
  if(!validateVideoSize(videoFile)) return;
  fd.append('file', videoFile);
  const prog = document.getElementById('videoProgress');
  try{
    await uploadWithProgress('/api/videos', fd, prog);
    fetchVideos();
    alert('Video uploaded');
  }catch(e){ alert('Upload failed'); }
});

// Article image inline upload handler
document.getElementById('articleImageUploadBtn').addEventListener('click', async function(){
  const f = document.getElementById('articleImageFile').files[0];
  if(!f) { alert("Choisissez un fichier image d'abord"); return; }
  if(!validateImageSize(f)) return;
  const fd = new FormData();
  fd.append('title', 'article-inline');
  fd.append('description', 'uploaded from article form');
  fd.append('file', f);
  const prog = document.createElement('progress'); prog.value = 0; prog.max = 100; document.body.appendChild(prog);
  try{
    const res = await uploadWithProgress('/api/photos', fd, prog);
    // add to photo list and select
    await fetchPhotos();
    if(res && res.photo && res.photo.filename){
      const url = '/static/uploads/photos/' + res.photo.filename;
      const sel = document.getElementById('articleImageSelect');
      if(sel){ sel.value = url; }
    }
    alert('Image uploadée et attachée');
  }catch(e){ alert('Upload inline échoué'); }
  prog.remove();
});

// Article video inline upload handler
document.getElementById('articleVideoUploadBtn').addEventListener('click', async function(){
  const f = document.getElementById('articleVideoFile').files[0];
  if(!f) { alert("Choisissez un fichier vidéo d'abord"); return; }
  if(!validateVideoSize(f)) return;
  const fd = new FormData();
  fd.append('title', 'article-inline-video');
  fd.append('description', 'uploaded from article form');
  fd.append('file', f);
  const prog = document.createElement('progress'); prog.value = 0; prog.max = 100; document.body.appendChild(prog);
  try{
    const res = await uploadWithProgress('/api/videos', fd, prog);
    // add to video list and select
    await fetchVideos();
    if(res && res.video && res.video.filename){
      const url = '/static/uploads/videos/' + res.video.filename;
      const sel = document.getElementById('articleVideoSelect');
      if(sel){ sel.value = url; }
    }
    alert('Vidéo uploadée et attachée');
  }catch(e){ alert('Upload inline vidéo échoué'); }
  prog.remove();
});

// Initial load
fetchPhotos();
fetchVideos();
fetchArticles();
fetchSiteMeta();

// Clear article form
document.getElementById('articleClear').addEventListener('click', function(){
  document.getElementById('articleId').value = '';
  document.getElementById('articleTitle').value = '';
  document.getElementById('articleAuthor').value = '';
  document.getElementById('articleContent').value = '';
});

// Markdown toolbar helpers
document.querySelectorAll('.md-btn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const ins = btn.getAttribute('data-ins') || '';
    const ta = document.getElementById('articleContent');
    const start = ta.selectionStart || 0;
    const end = ta.selectionEnd || 0;
    const before = ta.value.slice(0,start);
    const after = ta.value.slice(end);
    ta.value = before + ins + ta.value.slice(start);
    ta.focus();
    ta.selectionStart = ta.selectionEnd = start + ins.length;
  });
});

document.getElementById('mdLinkBtn').addEventListener('click', ()=>{
  const ta = document.getElementById('articleContent');
  const url = prompt('URL (https://...)');
  if(!url) return;
  const text = prompt('Link text', 'link');
  const ins = `[${text}](${url})`;
  const start = ta.selectionStart || 0;
  const before = ta.value.slice(0,start);
  ta.value = before + ins + ta.value.slice(start);
  ta.focus();
});

// Minimal markdown -> HTML renderer (headings, bold, italic, lists, links, paragraphs)
function renderMarkdown(md){
  if(!md) return '';
  // escape
  const esc = md.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  const lines = esc.split(/\r?\n/);
  const out = [];
  let inList = false;
  lines.forEach(ln=>{
    if(/^###\s+/.test(ln)){ out.push(`<h3>${ln.replace(/^###\s+/,'')}</h3>`); return; }
    if(/^##\s+/.test(ln)){ out.push(`<h2>${ln.replace(/^##\s+/,'')}</h2>`); return; }
    if(/^#\s+/.test(ln)){ out.push(`<h1>${ln.replace(/^#\s+/,'')}</h1>`); return; }
    if(/^[-*]\s+/.test(ln)){
      if(!inList){ out.push('<ul>'); inList = true; }
      out.push(`<li>${ln.replace(/^[-*]\s+/,'')}</li>`);
      return;
    } else {
      if(inList){ out.push('</ul>'); inList = false; }
    }
    let ln2 = ln.replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>')
                .replace(/\*(.+?)\*/g,'<em>$1</em>')
                .replace(/\[(.*?)\]\((.*?)\)/g,'<a href="$2" target="_blank">$1</a>');
    if(ln2.trim()==='') out.push('<p></p>'); else out.push(`<p>${ln2}</p>`);
  });
  if(inList) out.push('</ul>');
  return out.join('\n');
}

document.getElementById('togglePreviewBtn').addEventListener('click', ()=>{
  const pv = document.getElementById('articlePreview');
  const ta = document.getElementById('articleContent');
  if(pv.style.display === 'none' || pv.style.display===''){
    pv.innerHTML = renderMarkdown(ta.value);
    pv.style.display = '';
    document.getElementById('togglePreviewBtn').textContent = 'Hide Preview';
  } else {
    pv.style.display = 'none';
    document.getElementById('togglePreviewBtn').textContent = 'Preview';
  }
});

async function fetchSiteMeta(){
  try{
    const r = await fetch('/api/site');
    const j = await r.json();
    document.getElementById('siteTitle').value = j.site_title || '';
    document.getElementById('siteSubtitle').value = j.site_subtitle || '';
    document.getElementById('footerText').value = j.footer_text || '';
    document.getElementById('pillarsHtml').value = j.pillars_html || '';
    document.getElementById('contactHtml').value = j.contact_html || '';
  }catch(e){ console.error('failed to load site meta', e); }
}

document.getElementById('siteMetaForm').addEventListener('submit', async function(e){
  e.preventDefault();
  const payload = {
    site_title: document.getElementById('siteTitle').value,
    site_subtitle: document.getElementById('siteSubtitle').value,
    footer_text: document.getElementById('footerText').value,
    pillars_html: document.getElementById('pillarsHtml').value,
    contact_html: document.getElementById('contactHtml').value
  };
  try{
    const res = await fetch('/api/site', {method:'PUT', headers: {'Content-Type':'application/json','X-CSRF-Token': CSRF}, body: JSON.stringify(payload)});
    if(res.ok){
      document.getElementById('siteMetaMsg').style.display='';
      document.getElementById('siteMetaMsg').textContent = 'Enregistré';
      setTimeout(()=> document.getElementById('siteMetaMsg').style.display='none', 3000);
    } else {
      const j = await res.json().catch(()=>({error:'unknown'}));
      alert('Enregistrement impossible: ' + (j.error || res.status));
    }
  }catch(e){ alert('Erreur réseau'); }
});
</script>
</body>
</html>
